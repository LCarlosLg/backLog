<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Clases Disponibles</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJzL2s/bHblC+eP+G35a3K217fX+h+G+K/sL2x+Z/P2/02+S/J3/29/A+W4/A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    /* ==========================
        RESET Y BASE
    ========================== */
    * {
        box-sizing: border-box;
    }

    body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f1f3f6;
        margin: 0;
        padding: 0;
        transition: 0.3s;
        overflow-x: hidden;
    }

    body.dark {
        background: #1e1e1e;
        color: white;
    }

    body.dark .container {
        background: #2a2a2a;
        color: white;
    }

    body.dark table {
        background: #333;
    }

    body.dark th {
        background: #1a273d !important;
    }

    body.dark td {
        border-bottom: 1px solid #444 !important;
        color: white;
    }

    body.dark tr:hover {
        background: #3b3b3b !important;
    }

    body.dark .btn-reservar {
        background: #1f3a60;
    }

    /* Estilos del Dark Mode para los Modales */
    body.dark .modal {
        background: #3a3a3a;
        color: #ffffff;
    }

    body.dark .modal h3 {
        color: #8ab4f8; /* Un azul claro */
    }

    body.dark .modal p {
        color: #c4c4c4;
    }

    body.dark .modal .detalle-clase {
        background: #2e2e2e;
        border: 1px solid #444;
    }

    body.dark .modal .detalle-clase p {
        color: #ffffff;
    }
    
    body.dark .btn-si {
        background: #8ab4f8;
        color: #1e1e1e;
    }
    
    body.dark .btn-no {
        background: #555;
        color: white;
    }


    /* ==========================
        SIDEBAR (Sin cambios, pero incluido para integridad)
    ========================== */
    .sidebar {
        position: fixed;
        left: -260px;
        top: 0;
        width: 260px;
        height: 100%;
        background: #2b3f5c;
        color: white;
        padding: 20px;
        transition: 0.4s ease;
        box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
        z-index: 2000;
    }

    .sidebar.active {
        left: 0;
    }

    .menu-title {
        font-size: 20px;
        margin-bottom: 20px;
        font-weight: 600;
        text-align: center;
    }

    .user-info {
        text-align: center;
        margin-bottom: 25px;
    }

    .user-info img {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        margin-bottom: 10px;
        border: 3px solid #fff;
    }

    .sidebar a {
        display: block;
        color: white;
        padding: 12px 10px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 15px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .sidebar a:hover {
        background: #1c2940;
    }

    .menu-btn {
        position: fixed;
        left: 20px;
        top: 20px;
        background: #2b3f5c;
        border: none;
        color: white;
        padding: 12px 15px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        z-index: 3000;
    }

    /* ==========================
        SWITCH (Sin cambios, pero incluido para integridad)
    ========================== */
    .switch-container {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.3);
    }

    .switch-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .switch {
        position: relative;
        width: 50px;
        height: 26px;
    }

    .switch input { display: none; }

    .slider {
        position: absolute;
        background: #999;
        border-radius: 50px;
        inset: 0;
        cursor: pointer;
        transition: 0.3s;
    }

    .slider::before {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        left: 3px;
        top: 3px;
        border-radius: 50%;
        transition: 0.3s;
    }

    input:checked + .slider {
        background: #4a90e2;
    }

    input:checked + .slider::before {
        transform: translateX(24px);
    }

    /* ==========================
        CERRAR SESI√ìN (Sin cambios, pero incluido para integridad)
    ========================== */
    .logout-box {
        margin-top: 30px;
        padding-top: 15px;
        border-top: 1px solid rgba(255,255,255,0.3);
    }

    .logout-btn {
        width: 100%;
        background: #d9534f;
        border: none;
        color: white;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }

    /* ==========================
        CONTENEDOR PRINCIPAL (Sin cambios, pero incluido para integridad)
    ========================== */
    .container {
        max-width: 1100px;
        margin: 80px auto;
        background: white;
        padding: 30px;
        border-radius: 14px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        position: relative;
    }

    h1 {
        text-align: center;
        color: #2b3f5c;
        margin-bottom: 25px;
        font-size: 32px;
        font-weight: 700;
    }

    /* ==========================
        BUSCADOR (Sin cambios, pero incluido para integridad)
    ========================== */
    .search-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
    }

    .search-box {
        position: relative;
        width: 65%;
        min-width: 260px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 40px 12px 15px;
        font-size: 16px;
        border-radius: 10px;
        border: 1px solid #ccc;
    }

    .search-box i {
        position: absolute;
        right: 12px;
        top: 12px;
        font-size: 18px;
        color: #666;
    }

    /* ==========================
        FILTROS (Sin cambios, pero incluido para integridad)
    ========================== */
    .filter-btn {
        padding: 12px 20px;
        background: #2b3f5c;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        height: 48px;
    }

    .filter-panel {
        display: none;
        margin-top: 10px;
        background: #eef1f6;
        padding: 15px;
        border-radius: 12px;
    }

    .filter-panel input {
        width: 100%;
        padding: 10px;
        margin-bottom: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    /* ==========================
        TABLA (Sin cambios, pero incluido para integridad)
    ========================== */
    table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 12px;
    }

    th {
        background: #2b3f5c;
        color: white;
        padding: 14px;
        font-size: 17px;
        text-align: left;
    }

    td {
        padding: 12px;
        border-bottom: 1px solid #e2e2e2;
        color: #444;
    }

    tr:hover {
        background: #f5f7fa;
        transition: 0.2s;
    }

    .btn-reservar {
        background: #2b3f5c;
        padding: 8px 14px;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }

    /* ==========================
        MODALES BONITOS (ACTUALIZADOS)
    ========================== */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.55); /* M√°s oscuro */
        backdrop-filter: blur(6px); /* Mayor desenfoque */
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeIn .25s ease;
        z-index: 5000;
    }

    .modal {
        background: white;
        padding: 30px; /* M√°s padding */
        width: 380px; /* M√°s ancho */
        max-width: 90%;
        border-radius: 18px; /* M√°s redondeado */
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3); /* Sombra m√°s pronunciada */
        animation: zoomIn .3s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Animaci√≥n m√°s 'rebotona' */
        position: relative;
    }

    .modal h3 {
        margin-top: 10px;
        font-size: 24px;
        color: #2b3f5c;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .modal-icon {
        font-size: 40px;
        margin-bottom: 15px;
        display: block;
    }

    /* Icono de Confirmaci√≥n */
    #modalConfirmar .modal-icon {
        color: #ffc107; /* Amarillo de advertencia */
    }

    /* Icono de √âxito */
    #modalExito .modal-icon {
        color: #28a745; /* Verde de √©xito */
    }

    .modal p {
        font-size: 16px;
        color: #555;
        margin-bottom: 25px;
        line-height: 1.5;
    }

    .detalle-clase {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: left;
    }

    .detalle-clase p {
        margin: 5px 0;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .detalle-clase strong {
        color: #2b3f5c;
        display: inline-block;
        min-width: 70px;
    }

    .modal-footer {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
    }

    .modal button {
        padding: 12px 25px;
        border: none;
        border-radius: 10px; /* M√°s redondeado */
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background 0.2s, transform 0.1s;
    }

    .modal button:active {
        transform: scale(0.98);
    }

    .btn-si {
        background: #28a745; /* Verde para la acci√≥n principal */
        color: white;
    }

    .btn-si:hover {
        background: #218838;
    }

    .btn-no {
        background: #f8f9fa; /* Fondo claro para la acci√≥n secundaria */
        border: 1px solid #ccc;
        color: #6c757d;
    }

    .btn-no:hover {
        background: #e2e6ea;
    }

    /* Estilos del bot√≥n Aceptar del modal de √©xito */
    #modalExito .btn-si {
        background: #2b3f5c; /* Usamos el color principal de la app */
    }
    
    #modalExito .btn-si:hover {
        background: #1c2940;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes zoomIn {
        0% { transform: scale(.7); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* ==========================
        CALENDARIO (Sin cambios, pero incluido para integridad)
    ========================== */
    #calendar {
        margin-top: 40px;
        background: white;
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }

    body.dark #calendar {
        background: #2a2a2a;
    }

</style>
</head>

<body>

<button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>

<div class="sidebar" id="sidebar">

    <div class="menu-title">Men√∫</div>

    <div class="user-info">
        <img id="avatar" src="" alt="Foto de perfil">
        <h3 id="nombreUsuario">Usuario</h3>
        <input type="file" id="inputFotoUsuario" accept="image/*" style="display:none">
    </div>

    <a href="#">üìå Adeudos</a>
    <a href="#">‚öô Configuraci√≥n</a>
    <a href="mis-reservas.html">üìö Mis reservas</a>

    <div class="switch-container">
        <div class="switch-row">
            <span>Modo oscuro</span>

            <label class="switch">
                <input type="checkbox" id="darkToggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="logout-box">
        <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
</div>

<div class="container">

    <h1>Clases Disponibles</h1>

    <div class="search-container">
        <div class="search-box">
            <input id="buscador" type="text" placeholder="Buscar clase por t√≠tulo, instructor, precio, etc...">
            <i>üîç</i>
        </div>

        <button class="filter-btn" onclick="toggleFilters()">Filtros</button>
    </div>

    <div id="panelFiltros" class="filter-panel">
        <input type="number" id="filtroCosto" placeholder="Costo m√°ximo">
        <input type="text" id="filtroHorario" placeholder="Horario (ej: 10:00)">
        <input type="number" id="filtroCupo" placeholder="Cupo m√≠nimo">
        <button class="filter-btn" onclick="aplicarFiltros()">Aplicar filtros</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>T√≠tulo</th>
                <th>Descripci√≥n</th>
                <th>Horario</th>
                <th>Cupo</th>
                <th>Precio</th>
                <th>Instructor</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>

        <tbody id="listaClases"></tbody>
    </table>

    <p id="sinClases" style="display:none;">No hay clases registradas por el momento.</p>

    <div id="calendar"></div>

</div>

<div id="modalConfirmar" class="modal-overlay">
    <div class="modal">
        <i class="fas fa-exclamation-triangle modal-icon"></i> <h3>Confirmar reserva</h3>
        <p>Est√°s a punto de reservar la siguiente clase. ¬øEst√°s seguro?</p>

        <div class="detalle-clase" id="detalleClaseConfirmar">
            <p><strong>Clase:</strong> <span id="modalTitulo"></span></p>
            <p><strong>Horario:</strong> <span id="modalHorario"></span></p>
            <p><strong>Costo:</strong> <span id="modalPrecio"></span></p>
        </div>

        <div class="modal-footer">
            <button class="btn-no" onclick="cerrarModal()">Cancelar</button>
            <button class="btn-si" onclick="confirmarReserva()">Reservar Ahora</button>
        </div>
    </div>
</div>

<div id="modalExito" class="modal-overlay">
    <div class="modal">
        <i class="fas fa-check-circle modal-icon"></i> <h3>¬°Reserva Exitosa!</h3>
        <p>üéâ Clase reservada correctamente. ¬°Revisa tu lista de "Mis Reservas" para m√°s detalles!</p>

        <div class="modal-footer">
            <button class="btn-si" onclick="cerrarModalExito()">Aceptar</button>
        </div>
    </div>
</div>


<script>
/* ==========================
    TOKEN (Contenido Omitido)
========================== */
const token = localStorage.getItem("token");
let clasesGlobal = [];
let idClaseSeleccionada = null;

if (!token) {
    alert("No hay token. Inicia sesi√≥n primero.");
    window.location.href = "login.html";
}

/* ==========================
    MENU (Contenido Omitido)
========================== */
function toggleMenu() {
    document.getElementById("sidebar").classList.toggle("active");
}

/* ==========================
    PERFIL (Contenido Omitido)
========================== */
const payload = JSON.parse(atob(token.split('.')[1]));
const nombre =
    payload.nombre ||
    payload.usuario ||
    payload.name ||
    payload.fullname ||
    payload.email?.split("@")[0] ||
    "Usuario";

document.getElementById("nombreUsuario").textContent = nombre;
const avatarEl = document.getElementById("avatar");

(async () => {
    try {
        const res = await fetch('/api/usuarios/perfil', {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (res.ok) {
            const data = await res.json();
            if (data.nombre) document.getElementById("nombreUsuario").textContent = data.nombre;

            if (data.foto && data.foto !== 'default.png') {
                avatarEl.src = `/uploads/${data.foto}`;
            } else {
                avatarEl.src = `https://api.dicebear.com/9.x/initials/svg?seed=${nombre}`;
            }
            return;
        }
    } catch (err) {}

    avatarEl.src = `https://api.dicebear.com/9.x/initials/svg?seed=${nombre}`;
})();

/* ==========================
    FOTO DE PERFIL (Contenido Omitido)
========================== */
const inputFotoUsuario = document.getElementById('inputFotoUsuario');

avatarEl.addEventListener('click', () => inputFotoUsuario.click());

inputFotoUsuario.addEventListener('change', async () => {
    if (!inputFotoUsuario.files.length) return;

    const formData = new FormData();
    formData.append('foto', inputFotoUsuario.files[0]);

    const res = await fetch('/api/usuarios/foto', {
        method: 'POST',
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
    });

    const data = await res.json();

    if (data.foto) {
        avatarEl.src = '/uploads/' + data.foto;
        alert("Foto actualizada");
    }
});

/* ==========================
    DARK MODE (Contenido Omitido)
========================== */
const toggle = document.getElementById("darkToggle");
toggle.addEventListener("change", () => {
    document.body.classList.toggle("dark", toggle.checked);
});

/* ==========================
    LOGOUT (Contenido Omitido)
========================== */
function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
}

/* ==========================
    CARGA DE CLASES (Contenido Omitido)
========================== */
fetch("/api/clases", {
    headers: { "Authorization": `Bearer ${token}` }
})
.then(res => res.json())
.then(clases => {
    clasesGlobal = clases;
    mostrarClases(clases);
    cargarCalendario(clases);
});

/* ==========================
    MOSTRAR TABLA (Contenido Omitido)
========================== */
function mostrarClases(lista) {
    const tabla = document.getElementById("listaClases");
    const mensaje = document.getElementById("sinClases");

    tabla.innerHTML = "";

    if (lista.length === 0) {
        mensaje.style.display = "block";
        return;
    }

    mensaje.style.display = "none";

    lista.forEach(c => {
        const row = document.createElement("tr");

        const horarioFormato = new Date(c.horario).toLocaleString("es-MX", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
        });

        row.innerHTML = `
            <td>${c.titulo}</td>
            <td>${c.descripcion}</td>
            <td>${horarioFormato}</td>
            <td>${c.cupo_maximo}</td>
            <td>$${c.precio}</td>
            <td>${c.instructor}</td>
            <td>
                <button class="btn-reservar" onclick="abrirModal(${c.id_clase})">Reservar</button>
            </td>
        `;

        tabla.appendChild(row);
    });
}

/* ==========================
    MODALES (ACTUALIZADO)
========================== */

function abrirModal(id) {
    idClaseSeleccionada = id;
    const clase = clasesGlobal.find(c => c.id_clase === id);

    if (clase) {
        const horarioFormato = new Date(clase.horario).toLocaleString("es-MX", {
            year: "numeric", month: "long", day: "numeric",
            hour: "2-digit", minute: "2-digit"
        });
        
        // Llenar los campos en el modal
        document.getElementById("modalTitulo").textContent = clase.titulo;
        document.getElementById("modalHorario").textContent = horarioFormato;
        document.getElementById("modalPrecio").textContent = `$${clase.precio}`;

        document.getElementById("modalConfirmar").style.display = "flex";
    }
}

function cerrarModal() {
    document.getElementById("modalConfirmar").style.display = "none";
}

function cerrarModalExito() {
    document.getElementById("modalExito").style.display = "none";
}

function confirmarReserva() {
    cerrarModal();

    fetch(`/api/clases/reservar/${idClaseSeleccionada}`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
        }
    })
    .then(res => {
        if (!res.ok) {
            // Manejar error de reserva (ej: cupo lleno, ya reservada)
            // Se puede crear un modal de error similar al de √©xito si es necesario
            throw new Error('Error al reservar la clase.'); 
        }
        return res.json();
    })
    .then(data => {
        document.getElementById("modalExito").style.display = "flex";
    })
    .catch(error => {
        // Aqu√≠ se podr√≠a mostrar el modal de error
        alert("Hubo un error al procesar tu reserva. Intenta de nuevo."); 
    });
}

/* ==========================
    BUSCADOR (Contenido Omitido)
========================== */
document.getElementById("buscador").addEventListener("input", e => {
    const txt = e.target.value.toLowerCase();

    const resultado = clasesGlobal.filter(c =>
        c.titulo.toLowerCase().includes(txt) ||
        c.descripcion.toLowerCase().includes(txt) ||
        c.instructor.toLowerCase().includes(txt) ||
        c.horario.toLowerCase().includes(txt) ||
        c.precio.toString().includes(txt)
    );

    mostrarClases(resultado);
});

/* ==========================
    FILTROS (Contenido Omitido)
========================== */
function toggleFilters() {
    const panel = document.getElementById("panelFiltros");
    panel.style.display = panel.style.display === "block" ? "none" : "block";
}

function aplicarFiltros() {
    const costo = document.getElementById("filtroCosto").value;
    const hor = document.getElementById("filtroHorario").value.toLowerCase();
    const cupo = document.getElementById("filtroCupo").value;

    const res = clasesGlobal.filter(c => {
        const porCosto = costo === "" || c.precio <= costo;
        const porHorario = hor === "" || c.horario.toLowerCase().includes(hor);
        const porCupo = cupo === "" || c.cupo_maximo >= cupo;
        return porCosto && porHorario && porCupo;
    });

    mostrarClases(res);
}

/* ==========================
    CALENDARIO (Contenido Omitido)
========================== */
function cargarCalendario(clases) {
    const calendarEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: 650,
        events: clases.map(c => ({
            title: c.titulo + " - " + c.instructor,
            start: c.horario
        }))
    });

    calendar.render();
}
</script>

</body>
</html>